// example usage: 
// thread = mail.messageThread().thread(messages.map(
//   function(message) { 
//     return mail.message(message.subject, message.messageId, message.references);
//   }
// ));
// conversation = thread.getConversation(messageId);
(function(){function a(a,b,c){return function(a,b,c){return{subject:a,id:b,references:c}}(a,b,c)}function b(a){return function(a){function c(a){var b=this.getSpecificChild(a),c=[];return b&&(c=b.flattenChildren()),b.message&&c.unshift(b.message),c}function d(){var a=[];_.each(this.children,function(b){b.message&&a.push(b.message);var c=b.flattenChildren();c&&_.each(c,function(b){a.push(b)})});if(a.length>0)return a}function e(a){var b=this;if(b.message&&b.message.id==a)return b;var c=null;return _.each(b.children,function(b){var d=b.getSpecificChild(a);if(d){c=d;return}}),c}function f(){if(!this.message)return this;var a=this.parent;if(!a)return this;var b=a;while(a){a=a.parent;if(a){if(!a.message)return b;b=a}}return b}function g(a){a.parent&&a.parent.removeChild(a),this.children.push(a),a.parent=this}function h(a){this.children=_.without(this.children,a),delete a.parent}function i(a){if(this===a)return!0;if(this.children.length<1)return!1;var b=!1;return _.each(this.children,function(c){c.hasDescendant(a)&&(b=!0)}),b}var b=[];return{message:a,children:b,flattenChildren:d,getConversation:c,getSpecificChild:e,threadParent:f,addChild:g,removeChild:h,hasDescendant:i}}(a)}function c(){return function(){function c(c){a=this.createIdTable(c);var d=b();return _.each(_.keys(a),function(b){var c=a[b];_.include(_.keys(c),"parent")||d.addChild(c)}),delete a,f(d),d}function f(a){for(var b=a.children.length-1;b>=0;b--){var c=a.children[b];f(c),!c.message&&c.children.length===0?a.removeChild(c):!c.message&&c.children.length>0&&(!a.parent&&c.children.length===1?g(a,c):!a.parent&&c.children.length>1||g(a,c))}}function g(a,b){for(var c=b.children.length-1;c>=0;c--){var d=b.children[c];a.addChild(d)}a.removeChild(b)}function h(b){return a={},_.map(b,function(a){var b=i(a.id);b.message=a;var c=null,d=a.references||[];typeof d=="string"&&(d=[d]),_.each(d,function(a){var b=i(a);c&&!_.include(_.keys(b),"parent")&&!b.hasDescendant(c)&&c.addChild(b),c=b}),c&&!b.hasDescendant(c)&&c.addChild(b)}),a}function i(b){return _.include(_.keys(a),b)?a[b]:j(b)}function j(b){var c=e.messageContainer();return a[b]=c,c}function k(a){var b={};_.each(a.children,function(a){if(!a.message)var c=a.children[0];else var c=a;if(!c||!c.message)return;var e=c.message,f=d.normalizeSubject(e.subject);if(f.length===0)return;var g=b[f];g?typeof g.message!="undefined"&&(typeof c.message=="undefined"||d.isReplyOrForward(g.message.subject)&&!d.isReplyOrForward(e.subject))&&(b[f]=c):b[f]=c});for(var c=a.children.length-1;c>=0;c--){var f=a.children[c];if(f.message)var g=f.message.subject;else var g=f.children[0].message.subject;g=d.normalizeSubject(g);var h=b[g];if(!h||h===f)continue;if(typeof h.message=="undefined"&&typeof f.message=="undefined")_.each(f.children,function(a){h.addChild(a)}),f.parent.removeChild(f);else if(typeof h.message=="undefined"&&typeof f.message!="undefined")h.addChild(f);else if(!d.isReplyOrForward(h.message.subject)&&d.isReplyOrForward(f.message.subject))h.addChild(f);else{var i=e.messageContainer();i.addChild(h),i.addChild(f),b[g]=i}}return b}var a={};return{getContainer:i,createContainer:j,createIdTable:h,promoteChildren:g,pruneEmpties:f,groupBySubject:k,thread:c,idTable:a}}()}var d={isReplyOrForward:function(a){var b=/^(Re|Fwd)/i,c=a.match(b);return c?!0:!1},normalizeSubject:function(a){var b=/((Re|Fwd)(\[[\d+]\])?:(\s)?)*([\w]*)/i,c=a.match(b);return c?c[5]:!1},normalizeMessageId:function(a){var b=/<([^<>]+)>/,c=a.match(b);return c?c[1]:null},parseReferences:function(a){if(!a)return null;var b=/<[^<>]+>/g;return _.map(a.match(b),function(a){return a.match(/[^<>]+/)[0]})}},e=this.mail={message:a,messageContainer:b,messageThread:c,helpers:d};typeof module!="undefined"&&module.exports&&(_=require("underscore"),module.exports=e)})();